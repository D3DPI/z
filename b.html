<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>å²­å—ä¹å™¨å¢å¼ºç°å®è§†å¬å·¥å…·</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x5-page-mode" content="app">
  <meta name="x5-orientation" content="portrait">
  <meta name="full-screen" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- A-Frame & AR.js -->
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:-apple-system,Roboto; }
    /* â‘  è®©åœºæ™¯å…¨å±å¯è§ */
    a-scene {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    /* æ’­æ”¾æŒ‰é’® & ä¿¡æ¯æ  */
    #playBtn {
      position: absolute; top: 18px; left: 18px; z-index: 10;
      background: #888; border: 0; border-radius: 6px;
      padding: .6rem 1.2rem; color: #fff; opacity: .85;
      cursor: not-allowed;
    }
    #infoBox {
      position: absolute; top: 70px; left: 18px; right: 18px; z-index: 10;
      background: #fff; border-radius: 6px;
      padding: .8rem; font-size: .9rem; line-height: 1.4;
    }
    /* Debug UI åœ¨å³ä¸‹ */
    .arjs-debug-ui {
      bottom: 12px !important;
      right: 12px !important;
    }
  </style>
</head>

<body>
  <!-- æ’­æ”¾æŒ‰é’® & æ–‡æœ¬æç¤º -->
  <button id="playBtn" disabled>æ’­æ”¾</button>
  <div id="infoBox">è¯·ç”¨æ‘„åƒå¤´å¯¹å‡†â€œå²­å—ä¹å™¨ç â€</div>

  <!-- å…¨å±åœºæ™¯ï¼šå–æ¶ˆ embeddedï¼Œå¹¶å¼€å¯ debug UI -->
  <a-scene id="scene"
           vr-mode-ui="enabled:false"
           arjs="sourceType: webcam;
                 videoTexture: true;
                 debugUIEnabled: true;
                 debugUIContainerClass: arjs-debug-ui;">
    <!-- Marker 1 -->
    <a-marker id="marker1" preset="custom" url="pattern1.patt" marker-handler>
      <a-entity gltf-model="model1.gltf"
                scale="0.02 0.02 0.02"
                set-rotation="x:0; y:0; z:0">
      </a-entity>
    </a-marker>
    <!-- Marker 2 -->
    <a-marker id="marker2" preset="custom" url="pattern2.patt" marker-handler>
      <a-entity gltf-model="model2.gltf"
                scale="0.013 0.013 0.013"
                set-rotation="x:0; y:0; z:0">
      </a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    /* æ¨¡å‹åˆå§‹æ—‹è½¬ç»„ä»¶ */
    AFRAME.registerComponent('set-rotation', {
      schema:{ x:{type:'number',default:0}, y:{type:'number',default:0}, z:{type:'number',default:0} },
      init(){
        this.el.addEventListener('model-loaded', () => {
          const mesh = this.el.getObject3D('mesh');
          if(mesh){
            mesh.rotation.set(
              THREE.Math.degToRad(this.data.x),
              THREE.Math.degToRad(this.data.y),
              THREE.Math.degToRad(this.data.z)
            );
          }
        });
      }
    });

    /* Marker è¯†åˆ« + éŸ³é¢‘æ’­æ”¾ + ä¿¡æ¯æ›´æ–° */
    const audioMap = {
      marker1: { src:'audio1.mp3', info:'info1.txt' },
      marker2: { src:'audio2.mp3', info:'info2.txt' }
    };
    const cache = {};
    const playBtn = document.getElementById('playBtn');
    let ctx = null;

    AFRAME.registerComponent('marker-handler', {
      init(){
        const id = this.el.getAttribute('id');
        const cfg = audioMap[id] || {};
        if(cfg.src && !cache[cfg.src]){
          const a = new Audio(cfg.src);
          a.preload = 'auto';
          cache[cfg.src] = a;
        }
        let infoText = '';
        if(cfg.info){
          fetch(cfg.info)
            .then(r=>r.ok?r.text():'')
            .then(t=>infoText = t)
            .catch(()=>{});
        }
        let vis = false;
        this.tick = AFRAME.utils.throttleTick(() => {
          const now = this.el.object3D.visible;
          if(now !== vis){
            vis = now;
            if(now){
              if(ctx && ctx.audio && !ctx.audio.paused){
                ctx.audio.pause();
              }
              ctx = { audio: cache[cfg.src] || new Audio(cfg.src) };
              document.getElementById('infoBox').textContent = infoText || 'åŠ è½½ä¸­â€¦';
              updatePlayBtn();
            }
          }
        }, 100);
      }
    });

    playBtn.addEventListener('click', () => {
      if(!ctx || !ctx.audio) return;
      if(ctx.audio.paused){
        ctx.audio.play().then(updatePlayBtn);
      } else {
        ctx.audio.pause();
        updatePlayBtn();
      }
    });

    function updatePlayBtn(){
      if(!ctx){
        playBtn.disabled = true;
        playBtn.style.cursor = 'not-allowed';
        playBtn.textContent = 'æ’­æ”¾';
        return;
      }
      playBtn.disabled = false;
      playBtn.style.cursor = 'pointer';
      playBtn.textContent = ctx.audio.paused ? 'æ’­æ”¾' : 'æš‚åœ';
    }

    /* å¯é€‰ï¼šè°ƒè¯•è¾“å‡º */
    window.addEventListener('arjs-video-source-onReady', () => console.log('ğŸ“¹ æ‘„åƒå¤´å·²å°±ç»ª'));
    window.addEventListener('arjs-render-started', () => console.log('ğŸ•¶ï¸ AR.js æ¸²æŸ“å·²å¼€å§‹'));
  </script>
</body>
</html>
