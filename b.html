<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>岭南乐器增强现实视听工具</title>
    <!-- 引入 A-Frame 和 AR.js 库 -->
    <script src="aframe.min.js"></script>
    <script src="aframe-ar.js"></script>
    <style>
        #playButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: grey;
            color: white;
            border: none;
            cursor: not-allowed;
            z-index: 10;
        }
        #infoText {
            position: absolute;
            top: 70px;
            left: 20px;
            width: calc(100% - 40px);
            padding: 10px 20px;
            background-color: #FFF;
            color: #000;
            border: none;
            word-wrap: break-word;
            z-index: 10;
        }
    </style>
    <script>
        // 检测是否在微信浏览器中
        function isWeixinBrowser() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }

        var inWeixinBrowser = isWeixinBrowser();

        if (inWeixinBrowser) {
            // 显示引导页面
            document.addEventListener('DOMContentLoaded', function () {
                document.body.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <p>为了获得更好的体验，请点击右上角菜单，选择“在默认浏览器中打开”。</p>
                    </div>
                `;
            });
        } else {
            // 非微信浏览器，正常加载页面内容

            var activeMarkerData = null; // 全局变量，用于存储当前活动的标记数据
            var audioPlayers = {}; // 全局对象，用于存储音频播放器

            // 在页面加载时预加载音频
            document.addEventListener('DOMContentLoaded', function () {
                var audioFiles = ['audio1.mp3', 'audio2.mp3'];
                audioFiles.forEach(function (audioSrc) {
                    var audioPlayer = new Audio();
                    audioPlayer.src = audioSrc;
                    audioPlayer.preload = 'auto';
                    audioPlayer.load(); // 开始加载音频

                    audioPlayers[audioSrc] = {
                        audioPlayer: audioPlayer
                    };
                });

                // 添加播放按钮的事件监听器
                var playButton = document.getElementById('playButton');
                playButton.addEventListener('click', () => {
                    if (activeMarkerData && activeMarkerData.audioPlayer) {
                        var audioPlayer = activeMarkerData.audioPlayer;
                        if (audioPlayer.readyState >= 2) { // HAVE_CURRENT_DATA
                            if (audioPlayer.paused) {
                                audioPlayer.play().then(() => {
                                    activeMarkerData.isPlaying = true;
                                    playButton.textContent = '暂停';
                                }).catch(err => {
                                    console.error('Audio playback failed:', err);
                                    alert('无法播放音频，请与页面进行交互后重试。');
                                });
                            } else {
                                audioPlayer.pause();
                                activeMarkerData.isPlaying = false;
                                playButton.textContent = '播放';
                            }
                        } else {
                            alert('音频尚未加载完毕，请稍后再试。');
                        }
                    } else {
                        alert('没有检测到标记或音频尚未加载。');
                    }
                });
            });

            // 自定义组件，用于在模型加载后设置模型的旋转
            AFRAME.registerComponent('set-model-rotation', {
                schema: {
                    x: { type: 'number', default: 0 },
                    y: { type: 'number', default: 0 },
                    z: { type: 'number', default: 0 }
                },
                init: function () {
                    var el = this.el;
                    var data = this.data;

                    el.addEventListener('model-loaded', function(e) {
                        var model = el.getObject3D('mesh');
                        if (!model) return;
                        model.rotation.set(
                            THREE.Math.degToRad(data.x),
                            THREE.Math.degToRad(data.y),
                            THREE.Math.degToRad(data.z)
                        );
                    });
                }
            });

            AFRAME.registerComponent('marker-debug', {
                init: function () {
                    var markerEl = this.el;
                    var markerId = markerEl.getAttribute('id');
                    var audioPlayer = null;
                    var infoTextContent = '';
                    var isPlaying = false;
                    var playButton = document.getElementById('playButton');
                    var infoTextEl = document.getElementById('infoText');
                    var isMarkerVisible = false;
                    var audioLoaded = false;
                    var infoLoaded = false;

                    // 根据 markerId 设置音频和文本文件路径
                    var audioSrc = '';
                    var infoSrc = '';
                    if (markerId === 'marker1') {
                        audioSrc = 'audio1.mp3';
                        infoSrc = 'info1.txt';
                    } else if (markerId === 'marker2') {
                        audioSrc = 'audio2.mp3';
                        infoSrc = 'info2.txt';
                    }

                    // 获取已预加载的音频播放器
                    var audioData = audioPlayers[audioSrc];
                    if (audioData && audioData.audioPlayer) {
                        audioPlayer = audioData.audioPlayer;
                    } else {
                        console.error('Audio player not found for ' + audioSrc);
                        audioPlayer = new Audio();
                        audioPlayer.src = audioSrc;
                        audioPlayer.preload = 'auto';
                        audioPlayer.load();
                    }

                    // 加载文本
                    fetch(infoSrc)
                        .then(response => response.ok ? response.text() : '')
                        .then(data => {
                            infoTextContent = data;
                            infoLoaded = true;
                        })
                        .catch(err => {
                            console.error('Error loading info text:', err);
                            infoLoaded = false;
                        });

                    // 每一帧检查 marker 的可见性
                    this.tick = AFRAME.utils.throttleTick(function () {
                        var visible = markerEl.object3D.visible;
                        if (visible !== isMarkerVisible) {
                            isMarkerVisible = visible;
                            // 更新音频加载状态
                            audioLoaded = audioPlayer.readyState >= 2; // HAVE_CURRENT_DATA

                            if (isMarkerVisible) {
                                // 标记被检测到
                                if (activeMarkerData && activeMarkerData.markerId !== markerId) {
                                    // 如果有其他活动的标记，暂停其音频
                                    if (activeMarkerData.audioPlayer && !activeMarkerData.audioPlayer.paused) {
                                        activeMarkerData.audioPlayer.pause();
                                        activeMarkerData.isPlaying = false;
                                    }
                                }
                                // 更新全局的 activeMarkerData
                                activeMarkerData = {
                                    markerId: markerId,
                                    audioPlayer: audioPlayer,
                                    infoTextContent: infoTextContent,
                                    isPlaying: isPlaying,
                                    audioLoaded: audioLoaded,
                                    infoLoaded: infoLoaded
                                };
                                // 更新信息文本
                                infoTextEl.textContent = infoTextContent || 'No information available';
                                enablePlayButton();
                            } else {
                                // 标记丢失，保持当前文本和音频状态不变
                                // 不做任何处理，确保文本和音频播放稳定
                            }
                        }
                    }, 100); // 每100ms检查一次

                    function enablePlayButton() {
                        playButton.disabled = false;
                        playButton.style.backgroundColor = '#007BFF';
                        playButton.style.cursor = 'pointer';
                        playButton.textContent = isPlaying ? '暂停' : '播放';
                    }

                    function disablePlayButton() {
                        playButton.disabled = true;
                        playButton.style.backgroundColor = 'grey';
                        playButton.style.cursor = 'not-allowed';
                        playButton.textContent = 'Play';
                    }
                }
            });
        }
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <button id="playButton" disabled>播放</button>
    <div id="infoText">请用摄像头对准岭南乐器码</div>

    <!-- 修改后的 a-scene 标签，隐藏 AR.js 调试信息和 VR 模式按钮 -->
    <!-- 添加 sourceType: webcam; videoTexture: true; 以提高兼容性 -->
    <a-scene embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" vr-mode-ui="enabled: false">
        <a-marker id="marker1" preset="custom" url="pattern1.patt" marker-debug>
            <a-entity id="model1"
                position="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="model1.gltf"
                set-model-rotation="x:0; y:0; z:0">
            </a-entity>
        </a-marker>
        <a-marker id="marker2" preset="custom" url="pattern2.patt" marker-debug>
            <a-entity id="model2"
                position="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="model2.gltf"
                set-model-rotation="x:0; y:0; z:90">
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
