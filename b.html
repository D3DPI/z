<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>岭南乐器增强现实视听工具</title>

<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="x5-page-mode" content="app">
<meta name="x5-orientation" content="portrait">
<meta name="full-screen" content="yes">

<script src="aframe.min.js"></script>
<script src="aframe-ar.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:-apple-system,Roboto;}
  /* 覆层 + 按钮 */
  #cover{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
         background:#000;color:#fff;z-index:1000;transition:opacity .6s;}
  #startBtn{padding:.9rem 1.8rem;font-size:1rem;border:0;border-radius:9px;
           background:#1aad19;color:#fff;-webkit-tap-highlight-color:transparent;}
  #playBtn{position:absolute;top:18px;left:18px;z-index:10;cursor:not-allowed;background:#888;border:0;
           border-radius:6px;padding:.6rem 1.2rem;color:#fff;opacity:.85}
  #infoBox{position:absolute;top:70px;left:18px;right:18px;z-index:10;background:#fff;border-radius:6px;
           padding:.8rem;font-size:.9rem;line-height:1.4;}
</style>
</head>
<body>
  <!-- 启动覆层 -->
  <div id="cover">
    <p style="margin-bottom:1.4rem;font-size:1.12rem;">点击授权摄像头并进入 AR 体验</p>
    <button id="startBtn">进入 AR</button>
  </div>

  <!-- 控件 -->
  <button id="playBtn" disabled>播放</button>
  <div id="infoBox">请用摄像头对准“岭南乐器码”</div>

  <!-- A-Frame 场景 -->
  <a-scene embedded vr-mode-ui="enabled:false"
           arjs="sourceType:webcam; videoTexture:true; debugUIEnabled:false">
    <a-marker id="marker1" preset="custom" url="pattern1.patt" marker-handler>
      <a-entity gltf-model="model1.gltf" scale="0.02 0.02 0.02"
                set-rotation="x:0; y:0; z:0"></a-entity>
    </a-marker>
    <a-marker id="marker2" preset="custom" url="pattern2.patt" marker-handler>
      <a-entity gltf-model="model2.gltf" scale="0.013 0.013 0.013"
                set-rotation="x:0; y:0; z:0"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

<script>
/* ---------- 1. 按钮触发：申请权限 + 启动 AR ---------- */
const cover=document.getElementById('cover');
['touchstart','pointerdown','click'].forEach(evt=>{
  document.getElementById('startBtn').addEventListener(evt,startAR,{once:true,passive:true});
});

async function startAR(){
  // iOS 运动权限（可忽略拒绝）
  if(typeof DeviceMotionEvent?.requestPermission==='function'){
    try{await DeviceMotionEvent.requestPermission();}catch(e){}
  }
  const scene=document.querySelector('a-scene');
  const launch=()=>scene.systems.arjs.start();
  scene.hasLoaded?launch():scene.addEventListener('loaded',launch,{once:true});

  cover.style.opacity=0; setTimeout(()=>cover.remove(),600);
}

/* ---------- 2. 模型初始旋转 ---------- */
AFRAME.registerComponent('set-rotation',{
  schema:{x:{type:'number',default:0},y:{type:'number',default:0},z:{type:'number',default:0}},
  init(){
    this.el.addEventListener('model-loaded',()=>{
      const m=this.el.getObject3D('mesh');
      if(m) m.rotation.set(
        THREE.Math.degToRad(this.data.x),
        THREE.Math.degToRad(this.data.y),
        THREE.Math.degToRad(this.data.z)
      );
    });
  }
});

/* ---------- 3. 音频 / 信息 / Marker ---------- */
const audioMap={
  marker1:{src:'audio1.mp3',info:'info1.txt'},
  marker2:{src:'audio2.mp3',info:'info2.txt'}
};
const cache={},btn=document.getElementById('playBtn');let ctx=null;

AFRAME.registerComponent('marker-handler',{
  init(){
    const id=this.el.getAttribute('id'),cfg=audioMap[id]||{};
    if(cfg.src&&!cache[cfg.src]){cache[cfg.src]=new Audio(cfg.src);}
    let info='';
    if(cfg.info){fetch(cfg.info).then(r=>r.ok?r.text():'').then(t=>info=t);}
    let vis=false;
    this.tick=AFRAME.utils.throttleTick(()=>{
      const v=this.el.object3D.visible;
      if(v!==vis){vis=v;if(v){
        if(ctx&&ctx.a&&!ctx.a.paused)ctx.a.pause();
        ctx={a:cache[cfg.src]||new Audio(cfg.src)};
        document.getElementById('infoBox').textContent=info||'加载中…';
        upd();
      }}
    },100);
  }
});

/* ---------- 4. 播放按钮 ---------- */
btn.addEventListener('click',()=>{
  if(!ctx||!ctx.a)return;
  ctx.a.paused?ctx.a.play().then(upd):ctx.a.pause();
  upd();
});
function upd(){
  if(!ctx){btn.disabled=true;btn.style.cursor='not-allowed';btn.textContent='播放';return;}
  btn.disabled=false;btn.style.cursor='pointer';
  btn.textContent=ctx.a.paused?'播放':'暂停';
}
</script>
</body>
</html>
