<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v12</title>
    <script src="aframe.min.js"></script>
    <script src="aframe-ar.js"></script>
    <!-- 添加 GLTFLoader 脚本 -->
    <script src="three.min.js"></script>
    <script src="GLTFLoader.js"></script>
    <style>
        #playButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: grey;
            color: white;
            border: none;
            cursor: not-allowed;
        }
        #infoText {
            position: absolute;
            top: 60px;
            left: 20px;
            padding: 10px 20px;
            background-color: #FFF;
            color: #000;
            border: none;
        }
    </style>
</head>
<body style="margin: 0px; overflow: hidden;">
    <!-- 修改了<a-scene>标签，添加了getUserMediaConstraints -->
    <a-scene embedded arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false; getUserMediaConstraints: { video: { facingMode: { ideal: "environment" } } }'>
        <a-marker id="marker1" preset="custom" url="pattern1.patt">
            <a-entity id="model1"
                position="0 0 0"
                rotation="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="url(model1.gltf)">
            </a-entity>
        </a-marker>
        <a-marker id="marker2" preset="custom" url="pattern2.patt">
            <a-entity id="model2"
                position="0 0 0"
                rotation="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="url(model2.gltf)">
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
    
    <audio id="audioPlayer1" src="audio1.mp3"></audio>
    <audio id="audioPlayer2" src="audio2.mp3"></audio>
    <button id="playButton" disabled>Play</button>
    <div id="infoText">Scan a marker to display information</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed');

            const marker1 = document.getElementById('marker1');
            const model1 = document.getElementById('model1');
            const audioPlayer1 = document.getElementById('audioPlayer1');

            const marker2 = document.getElementById('marker2');
            const model2 = document.getElementById('model2');
            const audioPlayer2 = document.getElementById('audioPlayer2');

            const playButton = document.getElementById('playButton');
            const infoText = document.getElementById('infoText');

            let isPlaying = false;
            let currentAudioPlayer = null;
            let currentMarker = null;
            let info1Text = '';
            let info2Text = '';

            const preloadResources = () => {
                return Promise.all([
                    fetch('info1.txt')
                        .then(response => response.ok ? response.text() : 'Info1 not found')
                        .then(data => { info1Text = data; })
                        .catch(err => {
                            console.error('Error fetching info1.txt:', err);
                            info1Text = 'Info1 not found';
                        }),
                    fetch('info2.txt')
                        .then(response => response.ok ? response.text() : 'Info2 not found')
                        .then(data => { info2Text = data; })
                        .catch(err => {
                            console.error('Error fetching info2.txt:', err);
                            info2Text = 'Info2 not found';
                        }),
                    new Promise((resolve) => {
                        const audio1 = new Audio('audio1.mp3');
                        audio1.addEventListener('canplaythrough', resolve, { once: true });
                        audio1.addEventListener('error', () => {
                            console.error('Error loading audio1.mp3');
                            resolve();
                        });
                    }),
                    new Promise((resolve) => {
                        const audio2 = new Audio('audio2.mp3');
                        audio2.addEventListener('canplaythrough', resolve, { once: true });
                        audio2.addEventListener('error', () => {
                            console.error('Error loading audio2.mp3');
                            resolve();
                        });
                    }),
                    new Promise((resolve) => {
                        const loader = new THREE.GLTFLoader();
                        loader.load('model1.gltf', resolve, null, (err) => {
                            console.error('Error loading model1.gltf');
                            resolve();
                        });
                    }),
                    new Promise((resolve) => {
                        const loader = new THREE.GLTFLoader();
                        loader.load('model2.gltf', resolve, null, (err) => {
                            console.error('Error loading model2.gltf');
                            resolve();
                        });
                    })
                ]);
            };

            preloadResources().then(() => {
                console.log('All resources preloaded');
                enablePlayButton();
            }).catch(err => {
                console.error('Error preloading resources', err);
                enablePlayButton(); // 即使出错也启用播放按钮
            });

            const enablePlayButton = () => {
                playButton.disabled = false;
                playButton.style.backgroundColor = '#007BFF';
                playButton.style.cursor = 'pointer';
                playButton.textContent = 'Play';
            };

            const disablePlayButton = () => {
                playButton.disabled = true;
                playButton.style.backgroundColor = 'grey';
                playButton.style.cursor = 'not-allowed';
                playButton.textContent = 'Play';
            };

            const playAudio = (audioPlayer) => {
                if (currentAudioPlayer && currentAudioPlayer !== audioPlayer) {
                    currentAudioPlayer.pause();
                }
                audioPlayer.play();
                playButton.textContent = 'Pause';
                currentAudioPlayer = audioPlayer;
            };

            const pauseAudio = (audioPlayer) => {
                audioPlayer.pause();
                playButton.textContent = 'Play';
            };

            const markerFound = (marker, audioPlayer, infoTextContent) => {
                if (currentMarker && currentMarker !== marker) {
                    currentMarker.emit('markerLost');
                }
                console.log(`Marker ${marker.id} found`);
                currentMarker = marker;
                currentAudioPlayer = audioPlayer;
                infoText.textContent = infoTextContent;
                // 不自动播放音频，遵循浏览器自动播放策略
            };

            const markerLost = (marker, audioPlayer) => {
                console.log(`Marker ${marker.id} lost`);
                if (currentMarker === marker) {
                    infoText.textContent = 'Scan a marker to display information';
                    if (!audioPlayer.paused) {
                        isPlaying = true;
                        pauseAudio(audioPlayer);
                    } else {
                        isPlaying = false;
                    }
                    currentMarker = null;
                    currentAudioPlayer = null;
                }
            };

            marker1.addEventListener('markerFound', () => markerFound(marker1, audioPlayer1, info1Text));
            marker1.addEventListener('markerLost', () => markerLost(marker1, audioPlayer1));

            marker2.addEventListener('markerFound', () => markerFound(marker2, audioPlayer2, info2Text));
            marker2.addEventListener('markerLost', () => markerLost(marker2, audioPlayer2));

            playButton.addEventListener('click', () => {
                console.log('Play button clicked');
                if (currentAudioPlayer) {
                    if (currentAudioPlayer.paused) {
                        playAudio(currentAudioPlayer);
                    } else {
                        pauseAudio(currentAudioPlayer);
                    }
                } else {
                    console.log('No audio player selected');
                }
            });

            model1.addEventListener('click', () => {
                console.log('Model 1 clicked');
                if (audioPlayer1.paused) {
                    playAudio(audioPlayer1);
                } else {
                    pauseAudio(audioPlayer1);
                }
            });

            model2.addEventListener('click', () => {
                console.log('Model 2 clicked');
                if (audioPlayer2.paused) {
                    playAudio(audioPlayer2);
                } else {
                    pauseAudio(audioPlayer2);
                }
            });
        });
    </script>
</body>
</html>
