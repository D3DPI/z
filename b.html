<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom AR.js Pattern Marker</title>
    <!-- 只加载aframe和aframe-ar，不加载three.min.js和GLTFLoader.js -->
    <script src="aframe.min.js"></script>
    <script src="aframe-ar.js"></script>
    <style>
        #playButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: grey;
            color: white;
            border: none;
            cursor: not-allowed;
        }
        #infoText {
            position: absolute;
            top: 60px;
            left: 20px;
            padding: 10px 20px;
            background-color: #FFF;
            color: #000;
            border: none;
        }
    </style>
</head>
<body style="margin: 0px; overflow: hidden;">
    <a-scene embedded arjs>
        <a-marker id="marker1" preset="custom" url="pattern1.patt">
            <a-entity id="model1"
                position="0 0 0"
                rotation="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="url(model1.gltf)">
            </a-entity>
        </a-marker>
        <a-marker id="marker2" preset="custom" url="pattern2.patt">
            <a-entity id="model2"
                position="0 0 0"
                rotation="0 0 0"
                scale="0.02 0.02 0.02"
                gltf-model="url(model2.gltf)">
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
    
    <audio id="audioPlayer1" src="audio1.mp3" preload="auto"></audio>
    <audio id="audioPlayer2" src="audio2.mp3" preload="auto"></audio>
    <button id="playButton" disabled>Play</button>
    <div id="infoText">Scan a marker to display information</div>

    <script>
        // 保持摄像头初始化代码不变
        // Function to select the desired camera
        async function getCameraConstraints() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            const mainCamera = videoDevices.find(device => device.label.toLowerCase().includes('back')) || videoDevices[0];
            
            return {
                video: {
                    deviceId: mainCamera.deviceId
                }
            };
        }

        // Override AR.js default camera constraints
        ARjs.Context.prototype._initSource = async function(onReady) {
            const constraints = await getCameraConstraints();
            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    onReady(video);
                })
                .catch((err) => {
                    console.error("Error accessing camera: ", err);
                });
        };

        // 使用 window.load 事件，确保所有资源已加载
        window.addEventListener('load', () => {
            console.log('Window fully loaded and parsed');

            const marker1 = document.getElementById('marker1');
            const model1 = document.getElementById('model1');
            const audioPlayer1 = document.getElementById('audioPlayer1');

            const marker2 = document.getElementById('marker2');
            const model2 = document.getElementById('model2');
            const audioPlayer2 = document.getElementById('audioPlayer2');

            const playButton = document.getElementById('playButton');
            const infoText = document.getElementById('infoText');

            let currentAudioPlayer = null;
            let currentMarker = null;
            let info1Text = '';
            let info2Text = '';

            const preloadResources = () => {
                return Promise.all([
                    fetch('info1.txt')
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                            } else {
                                console.error('Failed to load info1.txt');
                                return '';
                            }
                        })
                        .then(data => { 
                            info1Text = data; 
                            console.log('info1Text loaded:', info1Text);
                        })
                        .catch(err => {
                            console.error('Error fetching info1.txt:', err);
                            info1Text = '';
                        }),
                    fetch('info2.txt')
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                            } else {
                                console.error('Failed to load info2.txt');
                                return '';
                            }
                        })
                        .then(data => { 
                            info2Text = data; 
                            console.log('info2Text loaded:', info2Text);
                        })
                        .catch(err => {
                            console.error('Error fetching info2.txt:', err);
                            info2Text = '';
                        })
                ]);
            };

            preloadResources().then(() => {
                console.log('Text resources preloaded');
                enablePlayButton();
            }).catch(err => {
                console.error('Error preloading resources', err);
                enablePlayButton(); // 即使出错也启用播放按钮
            });

            const enablePlayButton = () => {
                playButton.disabled = false;
                playButton.style.backgroundColor = '#007BFF';
                playButton.style.cursor = 'pointer';
                playButton.textContent = 'Play';
            };

            const disablePlayButton = () => {
                playButton.disabled = true;
                playButton.style.backgroundColor = 'grey';
                playButton.style.cursor = 'not-allowed';
                playButton.textContent = 'Play';
            };

            const playAudio = (audioPlayer) => {
                if (currentAudioPlayer && currentAudioPlayer !== audioPlayer) {
                    currentAudioPlayer.pause();
                }
                audioPlayer.play();
                playButton.textContent = 'Pause';
                currentAudioPlayer = audioPlayer;
            };

            const pauseAudio = (audioPlayer) => {
                audioPlayer.pause();
                playButton.textContent = 'Play';
            };

            const markerFound = (marker, audioPlayer, infoTextContent) => {
                if (currentMarker && currentMarker !== marker) {
                    currentMarker.emit('markerLost');
                }
                console.log(`Marker ${marker.id} found`);
                currentMarker = marker;
                currentAudioPlayer = audioPlayer;
                infoText.textContent = infoTextContent || 'No information available';
                console.log('Info text updated:', infoText.textContent);
                // 不自动播放音频，遵循浏览器自动播放策略
            };

            const markerLost = (marker, audioPlayer) => {
                console.log(`Marker ${marker.id} lost`);
                if (currentMarker === marker) {
                    infoText.textContent = 'Scan a marker to display information';
                    if (!audioPlayer.paused) {
                        pauseAudio(audioPlayer);
                    }
                    currentMarker = null;
                    currentAudioPlayer = null;
                }
            };

            // 确保实体已加载后再附加事件监听器
            marker1.addEventListener('loaded', () => {
                marker1.addEventListener('markerFound', () => markerFound(marker1, audioPlayer1, info1Text));
                marker1.addEventListener('markerLost', () => markerLost(marker1, audioPlayer1));
                console.log('Event listeners attached for marker1');
            });

            marker2.addEventListener('loaded', () => {
                marker2.addEventListener('markerFound', () => markerFound(marker2, audioPlayer2, info2Text));
                marker2.addEventListener('markerLost', () => markerLost(marker2, audioPlayer2));
                console.log('Event listeners attached for marker2');
            });

            playButton.addEventListener('click', () => {
                console.log('Play button clicked');
                if (currentAudioPlayer) {
                    if (currentAudioPlayer.paused) {
                        playAudio(currentAudioPlayer);
                    } else {
                        pauseAudio(currentAudioPlayer);
                    }
                } else {
                    console.log('No audio player selected');
                }
            });

            model1.addEventListener('click', () => {
                console.log('Model 1 clicked');
                if (audioPlayer1.paused) {
                    playAudio(audioPlayer1);
                } else {
                    pauseAudio(audioPlayer1);
                }
            });

            model2.addEventListener('click', () => {
                console.log('Model 2 clicked');
                if (audioPlayer2.paused) {
                    playAudio(audioPlayer2);
                } else {
                    pauseAudio(audioPlayer2);
                }
            });
        });
    </script>
</body>
</html>
