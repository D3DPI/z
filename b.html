<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>岭南乐器增强现实视听工具</title>

  <!-- 微信 X5 全屏 & 适配 -->
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x5-page-mode" content="app">
  <meta name="x5-orientation" content="portrait">
  <meta name="full-screen" content="yes">

  <!-- A-Frame & AR.js -->
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>

  <style>
    html,body { margin:0; height:100%; overflow:hidden; font-family:-apple-system,Roboto; }
    /* 全屏覆层 + 按钮 */
    #cover {
      position:fixed; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:#000; color:#fff; z-index:1000; transition:opacity .6s;
    }
    #startBtn {
      padding:.9rem 1.8rem; font-size:1rem; border:0; border-radius:9px;
      background:#1aad19; color:#fff; -webkit-tap-highlight-color:transparent;
    }
    /* 控件 */
    #playBtn {
      position:absolute; top:18px; left:18px; z-index:10; cursor:not-allowed;
      background:#888; border:0; border-radius:6px; padding:.6rem 1.2rem;
      color:#fff; opacity:.85;
    }
    #infoBox {
      position:absolute; top:70px; left:18px; right:18px; z-index:10;
      background:#fff; border-radius:6px; padding:.8rem;
      font-size:.9rem; line-height:1.4;
    }
    /* 隐藏视频元素 */
    #webcamVideo { display:none; }
  </style>
</head>

<body>
  <!-- 1. 覆层：提示 & 捕获手势 -->
  <div id="cover">
    <p style="margin-bottom:1.4rem; font-size:1.12rem;">点击授权摄像头并进入 AR 体验</p>
    <button id="startBtn">进入 AR</button>
  </div>

  <!-- 2. 隐藏的摄像头视频流 -->
  <video id="webcamVideo" autoplay playsinline muted></video>

  <!-- 3. 播放按钮 & 文本提示 -->
  <button id="playBtn" disabled>播放</button>
  <div id="infoBox">请用摄像头对准“岭南乐器码”</div>

  <!-- 4. A-Frame 场景，使用 video 源 -->
  <a-scene id="scene" embedded vr-mode-ui="enabled:false"
           arjs="sourceType: video; sourceUrl: #webcamVideo; debugUIEnabled:false">
    <a-marker id="marker1" preset="custom" url="pattern1.patt" marker-handler>
      <a-entity gltf-model="model1.gltf" scale="0.02 0.02 0.02"
                set-rotation="x:0; y:0; z:0"></a-entity>
    </a-marker>
    <a-marker id="marker2" preset="custom" url="pattern2.patt" marker-handler>
      <a-entity gltf-model="model2.gltf" scale="0.013 0.013 0.013"
                set-rotation="x:0; y:0; z:0"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

<script>
/*=== 1. 按钮触发：手势内申请摄像头 & Motion 权限，然后启动 AR.js ===*/
const cover = document.getElementById('cover');
const startBtn = document.getElementById('startBtn');

['pointerdown','touchstart','click'].forEach(evt => {
  startBtn.addEventListener(evt, startAR, { once:true, passive:true });
});

async function startAR() {
  // iOS 陀螺仪权限
  if (typeof DeviceMotionEvent?.requestPermission === 'function') {
    try { await DeviceMotionEvent.requestPermission(); } catch(e){}
  }
  // 手势内获取摄像头流
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }
    });
  } catch(e) {
    alert('无法获取摄像头权限，AR 体验已终止');
    return;
  }
  // 将流赋给隐藏 video
  const video = document.getElementById('webcamVideo');
  video.srcObject = stream;
  video.play();  // 有时需要显式 play

  // 隐藏覆层
  cover.style.opacity = 0;
  setTimeout(() => cover.remove(), 600);

  // 启动 AR.js
  const scene = document.getElementById('scene');
  const launch = () => scene.systems.arjs.start();
  if (scene.hasLoaded) launch();
  else scene.addEventListener('loaded', launch, { once:true });
}

/*=== 2. 模型初始旋转 组件 ===*/
AFRAME.registerComponent('set-rotation',{
  schema:{ x:{type:'number',default:0}, y:{type:'number',default:0}, z:{type:'number',default:0} },
  init(){
    this.el.addEventListener('model-loaded', ()=>{
      const mesh = this.el.getObject3D('mesh');
      if (!mesh) return;
      mesh.rotation.set(
        THREE.Math.degToRad(this.data.x),
        THREE.Math.degToRad(this.data.y),
        THREE.Math.degToRad(this.data.z)
      );
    });
  }
});

/*=== 3. 音频/信息/Marker 逻辑 ===*/
const audioMap = {
  marker1: { src:'audio1.mp3', info:'info1.txt' },
  marker2: { src:'audio2.mp3', info:'info2.txt' }
};
const cache = {};
const playBtn = document.getElementById('playBtn');
let ctx = null;

AFRAME.registerComponent('marker-handler',{
  init(){
    const id = this.el.getAttribute('id');
    const cfg = audioMap[id]||{};
    if (cfg.src && !cache[cfg.src]) {
      cache[cfg.src] = new Audio(cfg.src);
      cache[cfg.src].preload = 'auto';
    }
    let infoText = '';
    if (cfg.info) {
      fetch(cfg.info)
        .then(r=>r.ok ? r.text() : '')
        .then(t=>infoText=t)
        .catch(()=>{});
    }
    let visible = false;
    this.tick = AFRAME.utils.throttleTick(()=>{
      const now = this.el.object3D.visible;
      if (now !== visible) {
        visible = now;
        if (visible) {
          if (ctx && ctx.audio && !ctx.audio.paused) ctx.audio.pause();
          const audio = cache[cfg.src] || new Audio(cfg.src);
          ctx = { audio };
          document.getElementById('infoBox').textContent = infoText || '加载中…';
          updatePlayBtn();
        }
      }
    }, 100);
  }
});

playBtn.addEventListener('click', ()=>{
  if (!ctx || !ctx.audio) return;
  if (ctx.audio.paused) {
    ctx.audio.play().then(updatePlayBtn).catch(()=>alert('音频播放失败'));
  } else {
    ctx.audio.pause();
    updatePlayBtn();
  }
});

function updatePlayBtn(){
  if (!ctx) {
    playBtn.disabled = true;
    playBtn.textContent = '播放';
    playBtn.style.cursor = 'not-allowed';
    return;
  }
  playBtn.disabled = false;
  playBtn.style.cursor = 'pointer';
  playBtn.textContent = ctx.audio.paused ? '播放' : '暂停';
}
</script>
</body>
</html>
